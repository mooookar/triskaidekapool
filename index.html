<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>TriskaidekaPool</title>
        <style>
            * {
                padding: 0;
                margin: 0;
            }
            body {
                touch-action: none;
                height: 100vh;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                background: black;
                cursor: crosshair;
            }
            #score {
                pointer-events: none;
                color: white;
                height: 1rem;
            }
            #cnvs {
                width: max(320px, min(80vw, 80vh));
                height: max(320px, min(80vw, 80vh));
                background: #408323;
                background: radial-gradient(
                    circle,
                    #408323 0%,
                    #408323 46%,
                    #134918 100%
                );
                border: 1px solid black;
                transition: 0.1s;

                &.shake {
                    margin-left: 20px;
                }
            }
            #out {
                display: flex;
                justify-content: center;
                pointer-events: none;
                height: 1rem;
                & div {
                    font-size: 14px;
                    width: 15px;
                    height: 15px;
                    text-align: center;
                    border-radius: 50%;
                }
            }
        </style>
    </head>
    <body>
        <div id="score"></div>
        <canvas id="cnvs"></canvas>
        <div id="out"></div>
    </body>
    <script>
        'use strict';
        let // ZzFXMicro - Zuper Zmall Zound Zynth - v1.3.1 by Frank Force ~ 1000 bytes
            zzfxV = 0.3,
            zzfxX = new AudioContext(),
            zzfx = (
                p = 1,
                k = 0.05,
                b = 220,
                e = 0,
                r = 0,
                t = 0.1,
                q = 0,
                D = 1,
                u = 0,
                y = 0,
                v = 0,
                z = 0,
                l = 0,
                E = 0,
                A = 0,
                F = 0,
                c = 0,
                w = 1,
                m = 0,
                B = 0,
                N = 0
            ) => {
                let M = Math,
                    d = 2 * M.PI,
                    R = 44100,
                    G = (u *= (500 * d) / R / R),
                    C = (b *= ((1 - k + 2 * k * M.random((k = []))) * d) / R),
                    g = 0,
                    H = 0,
                    a = 0,
                    n = 1,
                    I = 0,
                    J = 0,
                    f = 0,
                    h = N < 0 ? -1 : 1,
                    x = (d * h * N * 2) / R,
                    L = M.cos(x),
                    Z = M.sin,
                    K = Z(x) / 4,
                    O = 1 + K,
                    X = (-2 * L) / O,
                    Y = (1 - K) / O,
                    P = (1 + h * L) / 2 / O,
                    Q = -(h + L) / O,
                    S = P,
                    T = 0,
                    U = 0,
                    V = 0,
                    W = 0;
                e = R * e + 9;
                m *= R;
                r *= R;
                t *= R;
                c *= R;
                y *= (500 * d) / R ** 3;
                A *= d / R;
                v *= d / R;
                z *= R;
                l = (R * l) | 0;
                p *= zzfxV;
                for (h = (e + m + r + t + c) | 0; a < h; k[a++] = f * p)
                    ++J % ((100 * F) | 0) ||
                        ((f = q
                            ? 1 < q
                                ? 2 < q
                                    ? 3 < q
                                        ? Z(g ** 3)
                                        : M.max(M.min(M.tan(g), 1), -1)
                                    : 1 - (((((2 * g) / d) % 2) + 2) % 2)
                                : 1 - 4 * M.abs(M.round(g / d) - g / d)
                            : Z(g)),
                        (f =
                            (l ? 1 - B + B * Z((d * a) / l) : 1) *
                            (f < 0 ? -1 : 1) *
                            M.abs(f) ** D *
                            (a < e
                                ? a / e
                                : a < e + m
                                ? 1 - ((a - e) / m) * (1 - w)
                                : a < e + m + r
                                ? w
                                : a < h - c
                                ? ((h - a - c) / t) * w
                                : 0)),
                        (f = c
                            ? f / 2 +
                              (c > a
                                  ? 0
                                  : ((a < h - c ? 1 : (h - a) / c) *
                                        k[(a - c) | 0]) /
                                    2 /
                                    p)
                            : f),
                        N
                            ? (f = W =
                                  S * T +
                                  Q * (T = U) +
                                  P * (U = f) -
                                  Y * V -
                                  X * (V = W))
                            : 0),
                        (x = (b += u += y) * M.cos(A * H++)),
                        (g += x + x * E * Z(a ** 5)),
                        n && ++n > z && ((b += v), (C += v), (n = 0)),
                        !l || ++I % l || ((b = C), (u = G), (n = n || 1));
                p = zzfxX.createBuffer(1, h, R);
                p.getChannelData(0).set(k);
                b = zzfxX.createBufferSource();
                b.buffer = p;
                b.connect(zzfxX.destination);
                b.start();
            };

        const cnvs = document.getElementById('cnvs');
        const outDiv = document.getElementById('out');
        const scoreDiv = document.getElementById('score');
        const W = cnvs.getBoundingClientRect().width;
        const R = W / 32; // ball radius
        const D = R * 2; // ball diameter
        cnvs.width = cnvs.height = W;
        const c = cnvs.getContext('2d');
        const PI = Math.PI;
        let out = [];
        let limit = 0; // this is limit for recursions

        //Prepare another canvas to draw runes' images
        const swatch = document.createElement('canvas');
        const sw = swatch.getContext('2d', { willReadFrequently: true });
        swatch.width = D * 7;
        swatch.height = D;

        sw.strokeStyle = 'white';
        sw.lineWidth = R / 10;

        //013
        sw.beginPath();
        sw.arc(R, R, R * 0.9, 0, PI * 2);
        sw.stroke();
        sw.closePath();
        sw.beginPath();
        sw.moveTo(R + R * 0.7, R - R * 0.7);
        sw.lineTo(R - R * 0.7, R + R * 0.7);
        sw.moveTo(R - R * 0.7, R - R * 0.7);
        sw.lineTo(R + R * 0.7, R + R * 0.7);
        sw.stroke();
        sw.closePath();

        //112
        sw.beginPath();
        sw.arc(D + R, R, R * 0.9, 0, PI * 2);
        sw.stroke();
        sw.closePath();
        sw.beginPath();
        sw.arc(D + R, R, 1, 0, PI * 2);
        sw.stroke();
        sw.closePath();

        //211
        sw.beginPath();
        sw.arc(D * 2 + R * 0.8, R, R * 0.2, 0, PI);
        sw.arc(D * 2 + R, R, R * 0.4, PI, 0);
        sw.arc(D * 2 + R * 0.8, R, R * 0.6, 0, PI);
        sw.arc(D * 2 + R, R, R * 0.8, PI, 0);
        sw.arc(D * 2 + R * 0.8, R, R, 0, PI / 4);
        sw.stroke();
        sw.closePath();

        //310
        sw.beginPath();
        sw.arc(D * 3 + R, R, R * 0.8, 0, PI * 2);
        sw.stroke();
        sw.closePath();
        sw.beginPath();
        sw.moveTo(D * 3 + R, 0);
        sw.lineTo(D * 3 + R * 0.8, R);
        sw.lineTo(D * 3 + R * 1.2, R);
        sw.lineTo(D * 3 + R, D);
        sw.stroke();
        sw.closePath();

        //49
        sw.beginPath();
        sw.arc(D * 4 + R, R, R * 0.9, 0, PI * 2);
        sw.moveTo(D * 4, R);
        sw.lineTo(D * 4 + R / 2, R);
        sw.lineTo(D * 4 + R * 0.8, R - R * 0.6);
        sw.lineTo(D * 4 + R * 1.2, R + R * 0.6);
        sw.lineTo(D * 4 + R * 1.5, R);
        sw.lineTo(D * 5 - 1, R);
        sw.stroke();
        sw.closePath();

        //58
        sw.beginPath();
        sw.moveTo(D * 5, R / 4);
        sw.lineTo(D * 6 - 1, R / 4);
        sw.lineTo(D * 5 + R, D - R / 5);
        sw.lineTo(D * 5, R / 4);
        sw.stroke();
        sw.closePath();

        //67
        sw.beginPath();
        sw.arc(D * 6 + R, R, R / 2.5, 0, PI * 2);
        sw.stroke();
        sw.closePath();
        sw.beginPath();
        sw.arc(D * 6 + R, R, R * 0.8, PI * -1.2, PI * -1.5);
        sw.moveTo(D * 6, R * 1.4);
        sw.lineTo(D * 6 + R * 0.4, R * 1.6);
        sw.lineTo(D * 6 + R * 0.5, R * 1.2);
        sw.stroke();
        sw.closePath();

        const colors = [
            'red',
            'lime',
            'plum',
            'gold',
            'tan',
            'coral',
            'blue',
            'blue',
            'coral',
            'tan',
            'gold',
            'plum',
            'lime',
            'red',
        ];

        class Vec2 {
            constructor(x, y) {
                this.x = x ? x : 0;
                this.y = y ? y : 0;
            }

            add(v) {
                if (typeof v === 'number') {
                    this.x += v;
                    this.y += v;
                } else {
                    this.x += v.x;
                    this.y += v.y;
                }
                return this;
            }
            subtr(v) {
                if (typeof v === 'number') {
                    this.x -= v;
                    this.y -= v;
                } else {
                    this.x -= v.x;
                    this.y -= v.y;
                }
                return this;
            }
            div(v) {
                if (typeof v === 'number') {
                    this.x /= v;
                    this.y /= v;
                } else {
                    this.x /= v.x;
                    this.y /= v.y;
                }
                return this;
            }
            mult(v) {
                if (typeof v === 'number') {
                    this.x *= v;
                    this.y *= v;
                } else {
                    this.x *= v.x;
                    this.y *= v.y;
                }
                return this;
            }
            copy() {
                return new Vec2(this.x, this.y);
            }
            length() {
                return Math.sqrt(this.x * this.x + this.y * this.y);
            }
            norm() {
                let l = this.length();
                return this.div(l);
            }
            distFrom(obj) {
                return Math.sqrt(
                    (this.x - obj.x) * (this.x - obj.x) +
                        (this.y - obj.y) * (this.y - obj.y)
                );
            }
        }

        const drawRunes = (o) => {
            c.save();
            c.globalCompositeOperation = 'overlay';
            if (o.type === '013') {
                c.putImageData(
                    sw.getImageData(0, 0, D, D),
                    o.crd.x - R,
                    o.crd.y - R
                );
            } else if (o.type === '112') {
                c.putImageData(
                    sw.getImageData(D, 0, D, D),
                    o.crd.x - R,
                    o.crd.y - R
                );
            } else if (o.type === '211') {
                c.putImageData(
                    sw.getImageData(D * 2, 0, D, D),
                    o.crd.x - R,
                    o.crd.y - R
                );
            } else if (o.type === '310') {
                c.putImageData(
                    sw.getImageData(D * 3, 0, D, D),
                    o.crd.x - R,
                    o.crd.y - R
                );
            } else if (o.type === '49') {
                c.putImageData(
                    sw.getImageData(D * 4, 0, D, D),
                    o.crd.x - R,
                    o.crd.y - R
                );
            } else if (o.type === '58') {
                c.putImageData(
                    sw.getImageData(D * 5, 0, D, D),
                    o.crd.x - R,
                    o.crd.y - R
                );
            } else if (o.type === '67') {
                c.putImageData(
                    sw.getImageData(D * 6, 0, D, D),
                    o.crd.x - R,
                    o.crd.y - R
                );
            }
            c.restore();
        };

        class Rune {
            constructor(c, t) {
                this.crd = c;
                this.type = t;
                this.life = 3 + out.length; // the more balls are out - the longer runes last
            }

            draw() {
                drawRunes(this);
            }
        }

        class Ball {
            constructor(val, v, vel, clr) {
                this.val = val;
                this.crd = v;
                this.clr = clr;
                this.vel = vel;
                this.moving = false;
                this.used = 0;
            }

            update() {
                if (this.vel.x !== 0 && this.vel.y !== 0) {
                    this.moving = true;
                }

                if (!this.moving) {
                    return;
                }
                
               

                let ballNewPos = this.crd.add(this.vel);
                if (
                    ballNewPos.x < R ||
                    ballNewPos.x > W - R ||
                    ballNewPos.y < R ||
                    ballNewPos.y > W - R
                ) {
                    this.wet = false;
                    zzfx(
                        1,
                        0.05,
                        110,
                        0,
                        0,
                        0.1,
                        0,
                        1,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        1,
                        0,
                        0,
                        0
                    );
                }

                // bump the walls
                if (ballNewPos.x <= R) {
                    this.crd.x = R;
                    this.vel.x *= -1;
                }
                if (ballNewPos.x >= W - R) {
                    this.crd.x = W - R;
                    this.vel.x *= -1;
                }
                if (ballNewPos.y <= R) {
                    this.crd.y = R;
                    this.vel.y *= -1;
                }
                if (ballNewPos.y >= W - R) {
                    this.crd.y = W - R;
                    this.vel.y *= -1;
                }

                if (this.used > 0) {
                    this.used--;
                }

                this.vel = this.vel.mult(0.99);
                if (this.vel.length() < 0.003) {
                    this.stop();
                }

                this.crd = this.crd.add(this.vel);
            }
            stop() {
                this.wet = false;
                this.moving = false;
                this.vel = new Vec2(0, 0);
            }
            drawShadow() {
                let e = this.crd;

                c.beginPath();
                c.fillStyle = '#00000088';
                c.arc(
                    e.x + (e.x - W / 2) / (W / 20),
                    e.y + (e.y - W / 2) / (W / 20),
                    R * 1.1,
                    0,
                    PI * 2
                );
                c.fill();
                c.closePath();
            }

            draw() {
                let e = this.crd;

                c.beginPath();
                c.fillStyle = this.clr;
                c.arc(e.x, e.y, R, 0, PI * 2);
                c.fill();
                c.closePath();

                c.beginPath();
                c.fillStyle = '#FFFFFF99';
                c.arc(
                    e.x - (e.x - W / 2) / (W / R),
                    e.y - (e.y - W / 2) / (W / R),
                    R / 2.5,
                    0,
                    PI * 2
                );
                c.fill();
                c.closePath();

                c.beginPath();
                c.font = R * 1.2 + 'px sans-serif';
                c.textAlign = 'center';
                c.fillStyle = 'black';
                c.fillText(this.val, e.x, e.y + R / 2);
                c.closePath();

                if (this.val === out.length) {
                    // indicate target ball
                    c.save();
                    c.beginPath();
                    c.strokeStyle = 'white';
                    c.arc(e.x, e.y, R * 1.4, 0, PI * 2);
                    c.setLineDash([1, 2]);
                    c.stroke();
                    c.closePath();
                    c.restore();
                }
            }
        }

        class Game {
            constructor() {
                this.balls = [];
                this.runes = [];
                this.pole = { start: undefined };
                this.sockets = [
                    new Vec2(0, 0),
                    new Vec2(W / 2, 0),
                    new Vec2(W, 0),
                    new Vec2(0, W / 2),
                    new Vec2(W, W / 2),
                    new Vec2(0, W),
                    new Vec2(W / 2, W),
                    new Vec2(W, W),
                ];
                this.score = 0;
                this.run = false;
            }

            start() {
                this.drawSockets();
                const lh = W / 30;
                c.save();
                c.fillStyle = 'white';
                c.strokeStyle = 'white';
                c.font = lh - 1 + 'px sans-serif';
                c.textAlign = 'center';
                c.fillText('TriskaidekaPool', W / 2, lh * 1.5);
                c.fillText(
                    '1. Balls should be scored in order 0,1,2,..13',
                    W / 2,
                    lh * 3
                );
                c.fillText('No points gained otherwise', W / 2, lh * 4);
                c.fillText(
                    'Next ball will be highlighted if possible',
                    W / 2,
                    lh * 5
                );
                c.fillText(
                    '2. If two balls collide, and their sum equals 13,',
                    W / 2,
                    lh * 7
                );
                c.fillText(
                    'special runes will appear on the table',
                    W / 2,
                    lh * 8
                );
                c.fillText(
                    '3. Runes will vanish after number of uses',
                    W / 2,
                    W - lh * 4
                );
                c.fillText('Click to start', W / 2, W - lh * 2);

                drawRunes({ crd: { x: W * 0.25, y: lh * 10 }, type: '013' });
                drawRunes({ crd: { x: W * 0.25, y: lh * 12 }, type: '112' });
                drawRunes({ crd: { x: W * 0.25, y: lh * 14 }, type: '211' });
                drawRunes({ crd: { x: W * 0.25, y: lh * 16 }, type: '310' });
                drawRunes({ crd: { x: W * 0.25, y: lh * 18 }, type: '49' });
                drawRunes({ crd: { x: W * 0.25, y: lh * 20 }, type: '58' });
                drawRunes({ crd: { x: W * 0.25, y: lh * 22 }, type: '67' });

                c.textAlign = 'left';
                c.fillText('0+13 Repel the ball away', W * 0.25 + D, lh * 10.4);
                c.fillText('1+12 Stop all balls', W * 0.25 + D, lh * 12.4);
                c.fillText(
                    '2+11 Teleport the ball randomly',
                    W * 0.25 + D,
                    lh * 14.4
                );
                c.fillText(
                    '3+10 Give the ball speed boost',
                    W * 0.25 + D,
                    lh * 16.4
                );
                c.fillText('4+9 Shake the table', W * 0.25 + D, lh * 18.4);
                c.fillText(
                    '5+8 Pushes the ball to random socket',
                    W * 0.25 + D,
                    lh * 20.4
                );
                c.fillText(
                    '6+7 Return last ball to play',
                    W * 0.25 + D,
                    lh * 22.4
                );

                c.restore();
            }

            init() {
                this.score = 0;
                this.updateScore();
                this.balls = [
                    new Ball(
                        ' ',
                        new Vec2(W / 2, D * 3),
                        new Vec2(0, 0),
                        'lightgray'
                    ),
                ];
                for (let i = 0, c = 1, l = 2; i < 14; i++, c++) {
                    this.balls.push(
                        new Ball(
                            i,
                            new Vec2(
                                W / 2 - R - l * R + c * (D + 1),
                                W / 2 + l * D
                            ),
                            new Vec2(0, 0),
                            colors[i]
                        )
                    );
                    if (c === l) {
                        c = 0;
                        l++;
                    }
                }
            }

            gameOver() {
                this.balls = [];
                this.runes = [];
                out = [];
                this.updateOut();
                c.fillText('Game Over', W / 2, W / 2 - D);
                c.fillText('Final score: ' + this.score, W / 2, W / 2 + D);
            }

            updateScore() {
                scoreDiv.innerText = this.score;
            }

            handleCollision(ball1, ball2) {
                if (!ball1.moving && !ball2.moving) {
                    return;
                }

                const is13 = ball1.val + ball2.val === 13;
                let ball1NewPos = ball1.crd.add(ball1.vel);
                let ball2NewPos = ball2.crd.add(ball2.vel);

                var dist = ball1NewPos.distFrom(ball2NewPos);

                if (dist < D) {
                    if (ball1.used === 0 && ball2.used === 0) {
                        zzfx(
                            1.1,
                            0.05,
                            20,
                            0,
                            0,
                            0.04,
                            1,
                            1,
                            -1.1,
                            0,
                            0,
                            0,
                            0,
                            1,
                            1,
                            0,
                            0,
                            0.48,
                            0,
                            0,
                            656
                        );
                        if (is13) {
                            if ([0, 13].includes(ball1.val)) {
                                this.runes.push(
                                    new Rune(this.findFreePlace(), '013')
                                );
                            } else if ([1, 12].includes(ball1.val)) {
                                this.runes.push(
                                    new Rune(this.findFreePlace(), '112')
                                );
                            } else if ([2, 11].includes(ball1.val)) {
                                this.runes.push(
                                    new Rune(this.findFreePlace(), '211')
                                );
                            } else if ([3, 10].includes(ball1.val)) {
                                this.runes.push(
                                    new Rune(this.findFreePlace(), '310')
                                );
                            } else if ([4, 9].includes(ball1.val)) {
                                this.runes.push(
                                    new Rune(this.findFreePlace(), '49')
                                );
                            } else if ([5, 8].includes(ball1.val)) {
                                this.runes.push(
                                    new Rune(this.findFreePlace(), '58')
                                );
                            } else if ([6, 7].includes(ball1.val)) {
                                this.runes.push(
                                    new Rune(this.findFreePlace(), '67')
                                );
                            }
                        }
                        ball1.used = ball2.used = 2;
                    }

                    const temp = ball1.vel.copy();
                    ball1.vel = ball1.vel.add(
                        new Vec2(
                            ball1.crd.x - ball2.crd.x,
                            ball1.crd.y - ball2.crd.y
                        )
                            .norm()
                            .mult(ball1.vel.length() / 3)
                    );
                    ball2.vel = ball2.vel.add(
                        new Vec2(
                            ball2.crd.x - ball1.crd.x,
                            ball2.crd.y - ball1.crd.y
                        )
                            .norm()
                            .mult(temp.length() / 3)
                    );
                }
            }

            handleRunes(ball) {
                if (ball.wet) {
                    return;
                }
                const rune = this.runes.find(
                    (o) => o.crd.distFrom(ball.crd) < R * 1.5
                );
                rune && rune.life--;
                if (rune) {
                    ball.wet = true; // ball becomes 'wet' meaning it has interacted with rune, need some cooldounn
                }
                if (rune?.type === '67') {
                    if (ball.moving) {
                        zzfx(
                            1,
                            0.05,
                            473,
                            0.02,
                            0.11,
                            0.19,
                            1,
                            3,
                            0,
                            0,
                            50,
                            0.09,
                            0.03,
                            0,
                            0,
                            0,
                            0,
                            0.89,
                            0.14,
                            0.14,
                            0
                        );
                    }
                    if (out.at(-1)) {
                        const ball = out.at(-1);
                        ball.crd = this.findFreePlace();
                        ball.vel = new Vec2(0, 0);
                        this.balls.splice(ball.val + 1, 0, ball);
                        out.pop();
                        this.updateOut();
                    }
                } else if (rune?.type === '310') {
                    if (ball.moving) {
                        zzfx(
                            1.1,
                            0.05,
                            783,
                            0.28,
                            0.02,
                            0.01,
                            3,
                            4,
                            0,
                            -6,
                            25,
                            0,
                            0.02,
                            0,
                            8,
                            0,
                            0,
                            0.73,
                            0,
                            0.06,
                            0
                        );
                    }
                    ball.vel = ball.vel.mult(2);
                } else if (rune?.type === '211') {
                    if (ball.moving) {
                        zzfx(
                            2.1,
                            0.05,
                            618,
                            0.06,
                            0.28,
                            0.5,
                            0,
                            2.2,
                            0,
                            0,
                            -113,
                            0.06,
                            0.02,
                            0,
                            0,
                            0,
                            0,
                            0.75,
                            0.17,
                            0.1,
                            632
                        );
                    }
                    ball.crd = new Vec2(
                        Math.random() * (W - D) + R,
                        Math.random() * (W - D) + R
                    );
                } else if (rune?.type === '49') {
                    if (ball.moving) {
                        zzfx(
                            1.1,
                            0.05,
                            41,
                            0.07,
                            0.18,
                            0.5,
                            3,
                            2.9,
                            -1,
                            0,
                            0,
                            0,
                            0.06,
                            0.6,
                            0,
                            0.9,
                            0,
                            0.42,
                            0.05,
                            0.38,
                            0
                        );
                    }
                    cnvs.classList.toggle('shake');
                    setTimeout(() => cnvs.classList.toggle('shake'), 100);
                    this.balls.forEach((ball) =>
                        ball.vel.add(
                            new Vec2(
                                Math.random() * 0.2 - 0.1,
                                Math.random() * 0.2 - 0.1
                            )
                        )
                    );
                } else if (rune?.type === '013') {
                    if (ball.moving) {
                        zzfx(
                            1.3,
                            0.05,
                            100,
                            0.01,
                            0,
                            0.16,
                            1,
                            2.8,
                            -3,
                            0,
                            0,
                            0,
                            0,
                            1,
                            0,
                            0.3,
                            0,
                            0.52,
                            0.01,
                            0,
                            0
                        );
                    }
                    ball.vel = ball.vel.add(
                        new Vec2(
                            ball.crd.x - rune.crd.x,
                            ball.crd.y - rune.crd.y
                        )
                            .norm()
                            .mult(ball.vel.length())
                    );
                } else if (rune?.type === '112') {
                    if (ball.moving) {
                        zzfx(
                            1,
                            0.05,
                            360,
                            0.01,
                            0.27,
                            0.28,
                            0,
                            2.3,
                            0,
                            0,
                            0,
                            0,
                            0.08,
                            0,
                            24,
                            0,
                            0,
                            0.97,
                            0.23,
                            0,
                            0
                        );
                    }
                    this.balls.forEach((ball) => (ball.vel = new Vec2(0, 0)));
                } else if (rune?.type === '58') {
                    if (ball.moving) {
                        zzfx(
                            0.7,
                            0.05,
                            237,
                            0.05,
                            0.28,
                            0.15,
                            0,
                            3.6,
                            0,
                            114,
                            0,
                            0,
                            0.09,
                            0,
                            9.9,
                            0,
                            0,
                            0.76,
                            0.21,
                            0,
                            122
                        );
                    }
                    const s = this.sockets[Math.round(Math.random() * 120) % 6];
                    ball.vel = new Vec2(
                        s.x - ball.crd.x,
                        s.y - ball.crd.y
                    ).norm();
                }
            }

            findFreePlace() {
                limit++;
                const freePlace = new Vec2(
                    Math.random() * (W - D) + R,
                    Math.random() * (W - D) + R
                );
                const finalPlace =
                    this.balls.every(
                        (ball) =>
                            !out.includes(ball) &&
                            ball.crd.distFrom(freePlace) > D * 2
                    ) &&
                    this.runes.every(
                        (rune) => rune.crd.distFrom(freePlace) > D * 2
                    ) ||
                    limit > 100
                        ? freePlace
                        : this.findFreePlace();

                limit = 0;
                return finalPlace;
            }

            updateOut() {
                outDiv.innerHTML = '';
                out.forEach((ball, ind) => {
                    const ballDiv = document.createElement('div');
                    ballDiv.style.background =
                        ball.val === ind ? ball.clr : '#555';
                    ballDiv.innerText = ball.val;
                    outDiv.appendChild(ballDiv);
                });
            }

            update() {
                if (out.length === 14) {
                    this.run = false;
                    this.gameOver();
                    return;
                }
                this.balls.forEach((ball) => {
                    ball.update();
                    this.handleRunes(ball);
                    if (!ball.moving || out.includes(ball)) {
                        return;
                    }
                    if (
                        this.sockets.some((s) => ball.crd.distFrom(s) < R * 1.6)
                    ) {
                        if (ball.val !== ' ') {
                            out.push(ball);
                            this.updateOut();
                            zzfx(
                                5,
                                0.05,
                                428,
                                0.02,
                                0.06,
                                0.15,
                                1,
                                0.8,
                                0,
                                0,
                                359,
                                0.04,
                                0.05,
                                0,
                                0,
                                0.1,
                                0,
                                0.93,
                                0.02,
                                0,
                                -505
                            );
                            this.score = out.reduce((a, b, i) => {
                                return b.val === i ? a + b.val + 1 : a + 0;
                            }, 0);
                            this.updateScore();
                            this.balls.splice(this.balls.indexOf(ball), 1);
                            ball.stop();
                        } else {
                            zzfx(
                                1,
                                0.05,
                                326,
                                0,
                                0.2,
                                0.007,
                                0,
                                1.4,
                                18,
                                0,
                                -230,
                                0.02,
                                0,
                                0,
                                75,
                                0,
                                0,
                                0.57,
                                0.08,
                                0,
                                0
                            );
                            ball.vel = new Vec2(0, 0);
                            ball.crd = this.findFreePlace();
                        }
                    }
                });
                for (let i = 0; i < this.balls.length; i++) {
                    for (let j = 0; j < this.balls.length; j++) {
                        if (i === j) {
                            continue;
                        }
                        this.handleCollision(this.balls[i], this.balls[j]);
                    }
                }
                this.runes.forEach((o, i) => {
                    if (o.life < 1) {
                        this.runes.splice(i, 1);
                    }
                });
            }

            drawSockets() {
                c.save();
                c.fillStyle = 'black';
                c.strokeStyle = 'gold';
                c.strokeRect(0, 0, W, W);
                this.sockets.forEach((soc) => {
                    c.beginPath();
                    c.moveTo(soc.x, soc.y);
                    c.arc(soc.x, soc.y, R * 1.3, 0, PI * 2);
                    c.fill();
                    c.closePath();
                });
                c.restore();
            }

            drawPole() {
                if (this.pole.start) {
                    c.save();
                    c.beginPath();
                    c.moveTo(this.pole.start.x, this.pole.start.y);
                    c.lineTo(this.balls[0].crd.x, this.balls[0].crd.y);
                    c.strokeStyle = 'white';
                    c.setLineDash([5, 5]);
                    c.stroke();
                    c.closePath();
                    c.restore();
                }
            }

            draw() {
                c.clearRect(0, 0, W, W);

                this.runes.forEach((o) => o.draw());
                this.drawSockets();

                this.balls.forEach((ball) => ball.drawShadow());

                this.drawPole();

                this.balls.forEach((ball) => ball.draw());
            }
        }

        const game = new Game();

        const mousedown = () => {
            if (game.balls.some((e) => e.moving)) {
                return;
            }
            game.pole.start = new Vec2(
                event.clientX - cnvs.offsetLeft,
                event.clientY - cnvs.offsetTop
            );
            document.body.addEventListener('mousemove', mousemove);
            document.body.addEventListener('mouseup', mouseup);
        };
        const mousemove = (event) => {
            game.pole.start = new Vec2(
                event.clientX - cnvs.offsetLeft,
                event.clientY - cnvs.offsetTop
            );
        };
        const mouseup = (event) => {
            const newVelocity = new Vec2(
                event.clientX - cnvs.offsetLeft - game.balls[0].crd.x,
                event.clientY - cnvs.offsetTop - game.balls[0].crd.y
            );
            const m = newVelocity.length() / W;

            game.balls[0].vel = newVelocity
                .norm()
                .mult(Math.min(m, 1) + out.length / 13);
            game.pole.start = undefined;
            document.body.removeEventListener('mousemove', mousemove);
            document.body.removeEventListener('mouseup', mouseup);
        };

        const gameCycle = () => {
            if (game.run) {
                game.update();
                game.draw();
                requestAnimationFrame(gameCycle);
            } else {
                document.body.addEventListener('mousedown', launchGame);
                document.body.removeEventListener('mousemove', mousemove);
                document.body.removeEventListener('mouseup', mouseup);
                game.gameOver();
            }
        };

        const launchGame = () => {
            game.init();
            document.body.removeEventListener('mousedown', launchGame);
            document.body.addEventListener('mousedown', mousedown);
            game.run = true;
            gameCycle();
        };
        document.body.addEventListener('mousedown', launchGame);

        game.start();
    </script>
</html>
